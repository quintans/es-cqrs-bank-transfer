version: '3'

networks:
  my-network:
    driver: bridge

services:
  svc-account:
    build: 
      context: ./account
      # dockerfile: ./Dockerfile
    depends_on:
      - database
    environment:
      - ES_HOST=database
      - ES_NAME=accounts
      - API_PORT=8000
    networks:
      - my-network
    ports:
      - 8000:8000

  svc-poller:
    build: 
      context: ./poller
      # dockerfile: ./Dockerfile
    depends_on:
      - database
      - pulsar
    environment:
      - ES_HOST=database
      - ES_NAME=accounts
      - PULSAR_ADDRESS=pulsar:6650
      - TOPIC=accounts
    networks:
      - my-network

  svc-balance:
    build: 
      context: ./balance
      # dockerfile: ./Dockerfile
    depends_on:
      - pulsar
      - elastic
    environment:
      - PULSAR_ADDRESS=pulsar:6650
      - TOPIC=accounts
      - REDIS_ADDRESSES=redis:6379
    networks:
      - my-network
    ports:
      - 3000:3000

  database:
    image: postgres:12.3-alpine
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "postgres", "-U", "root" ]
      timeout: 45s
      interval: 10s
      retries: 10
    restart: always
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=accounts
    volumes:
      - ./scripts/db:/docker-entrypoint-initdb.d/
    networks:
      - my-network
    ports:
      - 5432:5432

  pulsar:
    image: apachepulsar/pulsar:2.6.0
    volumes:
      - pulsardata:/pulsar/data
      - pulsarconf:/pulsar/conf
    networks:
      - my-network
    ports:
      - 6650:6650
      - 8080:8080
    command: bin/pulsar standalone

  elastic:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      - my-network

  kibana:
    image: docker.elastic.co/kibana/kibana:7.8.0
    depends_on:
      - elastic
    ports:
      - 5601:5601
    environment:
      ELASTICSEARCH_URL: http://elastic:9200
      ELASTICSEARCH_HOSTS: http://elastic:9200
    networks:
      - my-network

  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"
    networks:
      - my-network

volumes:
  pulsardata:
  pulsarconf:
  data01:
    driver: local
